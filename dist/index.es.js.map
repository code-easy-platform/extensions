{"version":3,"file":"index.es.js","sources":["../src/lib/WorkerMessageReceiver.ts","../src/lib/WorkerMessageSender.ts","../src/lib/ExtensionRunner.ts","../src/lib/Extension.ts"],"sourcesContent":["\r\nexport class WorkerMessageReceiver {\r\n  public onMessage: ((event: MessageEvent) => void) | null = null;\r\n\r\n\r\n  constructor(private _target: Window | Worker) {\r\n    this._target.addEventListener('message', this._onMessageEvent.bind(this));\r\n  }\r\n\r\n\r\n  private _respond(messageId: string) {\r\n    this._target.postMessage({ messageId, type: 'response' });\r\n  }\r\n\r\n  private _onMessageEvent(event: MessageEvent | Event) {\r\n    if (!(event instanceof MessageEvent)) return;\r\n    if (event.data.type !== 'request') return;\r\n\r\n    this.onMessage?.(event.data.payload);\r\n    this._respond(event.data.messageId);\r\n  }\r\n}\r\n","import { IMessage } from './IMessage';\r\n\r\n\r\nexport class WorkerMessageSender {\r\n  private _messageQueue: Record<string, (() => void)> = {};\r\n\r\n\r\n  constructor(private _target: Window | Worker) {\r\n    this._target.onerror = this._onErrorEvent.bind(this);\r\n    this._target.onmessageerror = this._onErrorMessageEvent.bind(this);\r\n\r\n    this._target.addEventListener('error', this._onErrorEvent.bind(this));\r\n    this._target.addEventListener('message', this._onMessageEvent.bind(this));\r\n    this._target.addEventListener('messageerror', this._onErrorMessageEvent.bind(this));\r\n  }\r\n\r\n\r\n  public async send<T>(message: IMessage<T>) {\r\n    return new Promise((resolve, reject) => {\r\n      const newMessageId = crypto.randomUUID();\r\n\r\n      this._messageQueue[newMessageId] = () => {\r\n        delete this._messageQueue[newMessageId];\r\n        resolve('complete');\r\n      };\r\n\r\n      this._target.postMessage({\r\n        type: 'request',\r\n        payload: message,\r\n        messageId: newMessageId,\r\n      });\r\n\r\n\r\n      setTimeout(() => {\r\n        delete this._messageQueue[newMessageId];\r\n        reject('Time out');\r\n      }, 500);\r\n    });\r\n  }\r\n\r\n\r\n  private _onErrorEvent(event: MessageEvent | Event) {\r\n    if (!(event instanceof MessageEvent)) return;\r\n\r\n    console.log(event);\r\n  }\r\n\r\n  private _onErrorMessageEvent(event: MessageEvent | Event) {\r\n    if (!(event instanceof MessageEvent)) return;\r\n\r\n    console.log(event);\r\n  }\r\n\r\n  private _onMessageEvent(event: MessageEvent | Event) {\r\n    if (!(event instanceof MessageEvent)) return;\r\n    if (event.data.type !== 'response') return;\r\n\r\n    this._messageQueue[event.data.messageId]?.();\r\n  }\r\n}\r\n","import { WorkerMessageReceiver } from './WorkerMessageReceiver';\r\nimport { WorkerMessageSender } from './WorkerMessageSender';\r\nimport { IExporter } from './IExporter';\r\nimport { IMessage } from './IMessage';\r\n\r\n\r\nexport class ExtensionRunner {\r\n  private _worker: Worker | null = null;\r\n  private _workerMessageSender: WorkerMessageSender | null = null;\r\n  private _workerMessageReceiver: WorkerMessageReceiver | null = null;\r\n\r\n  public name = null;\r\n  public hasError = false;\r\n  public description = null;\r\n  public hasInitialized = false;\r\n\r\n\r\n  constructor(private _url: string) { }\r\n\r\n\r\n  public activate() {\r\n    const workerUrl = URL.createObjectURL(\r\n      new Blob(\r\n        [`import(\"${this._url}\").then(m => new m.default(self))`],\r\n        { type: \"text/javascript\" }\r\n      )\r\n    );\r\n\r\n    setTimeout(() => URL.revokeObjectURL(workerUrl), 0);\r\n\r\n    this._worker = new Worker(workerUrl, { type: 'module' });\r\n    this._workerMessageSender = new WorkerMessageSender(this._worker);\r\n    this._workerMessageReceiver = new WorkerMessageReceiver(this._worker);\r\n\r\n    this._workerMessageReceiver.onMessage = this._onEvent.bind(this);\r\n\r\n    this._workerMessageSender.send({ type: 'activate' })\r\n      .then(() => this.hasInitialized = true)\r\n      .catch(() => console.warn('Failed to activate a extension'))\r\n  }\r\n\r\n  public deactivate() {\r\n    this._workerMessageSender?.send({ type: 'deactivate' })\r\n      .then(() => {\r\n        this._worker?.terminate();\r\n\r\n        this._worker = null;\r\n        this.hasInitialized = false;\r\n        this._workerMessageSender = null;\r\n      })\r\n      .catch(() => console.warn('Failed to deactivate a extension'));\r\n  }\r\n\r\n\r\n  private _onEvent(message: IMessage) {\r\n    switch (message.type) {\r\n      case 'set:name':\r\n        this.name = message.payload || 'Nothing set here';\r\n        break;\r\n      case 'set:description':\r\n        this.description = message.payload || 'Nothing set here';\r\n        break;\r\n      case 'feedback':\r\n        this._handleFeedback(message.payload);\r\n        break;\r\n      case 'add:exporter':\r\n        this._handleAddExporter(message.payload);\r\n        break;\r\n      case 'remove:exporter':\r\n        this._handleRemoveExporter(message.payload);\r\n        break;\r\n      case 'download:file':\r\n        this._handleDownloadFile(message.payload);\r\n        break;\r\n\r\n      default: break;\r\n    }\r\n  }\r\n\r\n\r\n  private _handleAddExporter(payload: Pick<IExporter, 'key' | 'label'>) {\r\n    if (!payload) return;\r\n\r\n    ExtensionRunner.addExporter({\r\n      key: payload.key,\r\n      label: payload.label,\r\n      action: async (data: { project: Object }) => {\r\n        await this._workerMessageSender?.send({ payload: data, type: `exporters:${payload.key}` })\r\n      },\r\n    });\r\n  }\r\n\r\n  private _handleRemoveExporter(payload: string) {\r\n    if (!payload) return;\r\n\r\n    ExtensionRunner.removeExporter(payload);\r\n  }\r\n\r\n  private _handleDownloadFile(payload: { fileName: string; fileType: string; fileContent: string; }) {\r\n    if (!payload) return;\r\n\r\n    ExtensionRunner.downloadFile(payload.fileName, payload.fileType, payload.fileContent);\r\n  }\r\n\r\n  private _handleFeedback(payload: { message: string; type: string; }) {\r\n    if (!payload) return;\r\n\r\n    ExtensionRunner.feedback(payload.message, payload.type);\r\n  }\r\n\r\n\r\n  public static addExporter(_exporter: IExporter) {\r\n    throw new Error(\"Add exporter method not implemented yet\");\r\n  }\r\n\r\n  public static removeExporter(_key: string) {\r\n    throw new Error(\"Remove exporter method not implemented yet\");\r\n  }\r\n\r\n  public static downloadFile(_fileName: string, _fileType: string, _fileContent: string) {\r\n    throw new Error(\"Download file method not implemented yet\");\r\n  }\r\n\r\n  public static feedback(_message: string, _type: 'warning' | 'success' | 'error' | 'info') {\r\n    throw new Error(\"Feedback method not implemented yet\");\r\n  }\r\n}\r\n","import { WorkerMessageReceiver } from './WorkerMessageReceiver';\r\nimport { WorkerMessageSender } from './WorkerMessageSender';\r\nimport { IExporter } from './IExporter';\r\nimport { IMessage } from './IMessage';\r\n\r\n\r\nexport class Extension {\r\n  private _extensionId = crypto.randomUUID();\r\n  private _commands: Record<string, ((data: any) => void)> = {};\r\n\r\n  private _workerReceiver: WorkerMessageReceiver;\r\n  private _workerSender: WorkerMessageSender;\r\n\r\n\r\n  constructor(_target: Window | Worker) {\r\n    this._workerReceiver = new WorkerMessageReceiver(_target);\r\n    this._workerSender = new WorkerMessageSender(_target);\r\n\r\n    this._commands['activate'] = this.activate.bind(this);\r\n    this._commands['deactivate'] = this.deactivate.bind(this);\r\n\r\n    this._workerReceiver.onMessage = this._onEvent.bind(this);\r\n\r\n    this._onInit();\r\n  }\r\n\r\n\r\n  /**\r\n   * Use this prop to create a good name of the extension. This will be showed in the platform.\r\n   */\r\n  public name: string | null = null;\r\n  /**\r\n   * Use this prop to create a good description of the extension. This will be showed in the platform.\r\n   */\r\n  public description: string | null = null;\r\n  /**\r\n   * First function call when extension starts.\r\n   */\r\n  public activate() { }\r\n  /**\r\n   * Last function call when extension ends.\r\n   */\r\n  public deactivate() { }\r\n\r\n\r\n  /**\r\n   * All available commands to do in the platform\r\n   */\r\n  public readonly commands = {\r\n    /**\r\n     * Allow you to add a project exporter in the platform. You can develop a code export.\r\n     * \r\n     * @param exporter Object with a action\r\n     */\r\n    addExporter: async (exporter: Pick<IExporter, 'key' | 'label'> & { action: ((data: any) => void) }) => {\r\n      const commandKey = `${this._extensionId}:${exporter.key}`;\r\n\r\n      this._commands[`exporters:${commandKey}`] = exporter.action.bind(this);\r\n\r\n      await this._workerSender.send({\r\n        type: 'add:exporter',\r\n        payload: {\r\n          key: commandKey,\r\n          label: exporter.label,\r\n        },\r\n      });\r\n    },\r\n    /**\r\n     * Used to remove the project exporter\r\n     * \r\n     * @param key Key of the exporter previous added\r\n     */\r\n    removeExporter: async (key: string) => {\r\n      const commandKey = `${this._extensionId}:${key}`;\r\n\r\n      delete this._commands[`exporters:${commandKey}`];\r\n\r\n      await this._workerSender.send({\r\n        type: 'remove:exporter',\r\n        payload: commandKey,\r\n      });\r\n    },\r\n    /**\r\n     * Allow you to download some content in a file\r\n     * \r\n     * @param fileName Name of the generated file\r\n     * @param fileType extension of the file\r\n     * @param fileContent file content in string\r\n     */\r\n    downloadFile: async (fileName: string, fileType: string, fileContent: string) => {\r\n      await this._workerSender.send({\r\n        type: 'download:file',\r\n        payload: { fileName, fileType, fileContent },\r\n      });\r\n    },\r\n    /**\r\n     * Allow to show some feedback to the platform user\r\n     * \r\n     * @param message Message of the feedback\r\n     * @param type type of the feedback\r\n     */\r\n    feedback: async (message: string, type: 'warning' | 'success' | 'error' | 'info') => {\r\n      await this._workerSender.send({\r\n        type: 'feedback',\r\n        payload: { message, type },\r\n      });\r\n    },\r\n  } as const;\r\n\r\n\r\n  private _onEvent(message: IMessage) {\r\n    this._commands[message.type]?.(message.payload);\r\n  }\r\n\r\n  private async _onInit() {\r\n    await this._workerSender.send({\r\n      type: 'set:name',\r\n      payload: this.name || 'Nothing set here',\r\n    });\r\n    await this._workerSender.send({\r\n      type: 'set:description',\r\n      payload: this.description || 'Nothing set here',\r\n    });\r\n  }\r\n}\r\n"],"names":["WorkerMessageReceiver","_target","messageId","event","_a","WorkerMessageSender","message","resolve","reject","newMessageId","_b","ExtensionRunner","_url","workerUrl","payload","data","_exporter","_key","_fileName","_fileType","_fileContent","_message","_type","Extension","exporter","commandKey","key","fileName","fileType","fileContent","type"],"mappings":"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"}